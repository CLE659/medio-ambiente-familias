<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pequeños Guardianes - Instituto San Francisco de Asís</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Estilo extra para portada A4 */
    #portada-img {
      width: 100%;
      max-width: 595px; /* ancho A4 en px */
      height: auto;
      border: 2px dashed #8fd694;
      margin: 15px auto;
      display: block;
      cursor: pointer;
    }
    #portada-container {
      margin-bottom: 30px;
      text-align: center;
    }
    #descarga-diploma {
      background-color: #4caf50;
      color: white;
      padding: 12px 25px;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      display: inline-block;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      user-select: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>Pequeños Guardianes</h1>
    <p>Instituto San Francisco de Asís</p>
    <p><strong>Bienvenidos a Cuidando el medio ambiente en familia</strong></p>
    <p>Gracias por sumarte a los pequeños guardianes para cuidar nuestro planeta.</p>
  </header>

  <main class="container">
    <section id="portada-container">
      <label for="inputPortada" style="font-weight: bold; cursor: pointer; color:#2e7d32;">Haz click para subir la imagen de portada (A4)</label>
      <input type="file" id="inputPortada" accept="image/*" style="display:none" />
      <img id="portada-img" alt="Imagen de portada A4 - Clic para subir" title="Clic para subir imagen portada" />
    </section>

    <section id="desafios">
      <h2>Desafíos para Guardianes</h2>

      <!-- Desafío 1 -->
      <div class="desafio" data-nivel="1">
        <h3>1. Crear un juguete con materiales reciclables y subir tu imagen</h3>
        <input type="file" accept="image/*" id="uploadNivel1" />
        <button disabled id="btnCompletar1">Marcar desafío 1 como completado</button>
      </div>

      <!-- Desafío 2 -->
      <div class="desafio" data-nivel="2" style="margin-top:30px;">
        <h3>2. Realizar un dibujo mostrando un medioambiente limpio y otro sucio y subir tu imagen</h3>
        <input type="file" accept="image/*" id="uploadNivel2" disabled />
        <button disabled id="btnCompletar2">Marcar desafío 2 como completado</button>
      </div>

      <!-- Desafío 3 -->
      <div class="desafio" data-nivel="3" style="margin-top:30px;">
        <h3>3. Crear un video familiar explicando por qué es importante cuidar el medio ambiente</h3>
        <input type="file" accept="video/*" id="uploadNivel3" disabled />
        <button disabled id="btnCompletar3">Marcar desafío 3 como completado</button>
      </div>

      <div id="felicitacion" class="felicitacion"></div>
    </section>

    <section id="galeria" style="margin-top: 50px;">
      <h2>Misión Completa Guardianes</h2>
      <div class="galeria" id="galeriaContainer">
        <!-- Aquí se muestran todas las imágenes/videos subidos -->
      </div>

      <button id="descarga-diploma">Descargar Diploma PNG</button>
    </section>
  </main>

  <footer>
    <p>© 2025 Instituto San Francisco de Asís - Proyecto Pequeños Guardianes</p>
  </footer>

  <script>
    // Estado niveles y archivos subidos
    const niveles = [
      { id: 1, name: "Desafío 1", tipo: "image", completed: false, uploadInput: "uploadNivel1", btnCompletar: "btnCompletar1" },
      { id: 2, name: "Desafío 2", tipo: "image", completed: false, uploadInput: "uploadNivel2", btnCompletar: "btnCompletar2" },
      { id: 3, name: "Desafío 3", tipo: "video", completed: false, uploadInput: "uploadNivel3", btnCompletar: "btnCompletar3" }
    ];

    // Cargar progreso y archivos guardados en localStorage
    function cargarProgreso() {
      const progreso = JSON.parse(localStorage.getItem("guardianesProgreso")) || {};
      niveles.forEach(nivel => {
        if (progreso[nivel.id]) {
          nivel.completed = true;
          habilitarNivel(nivel.id, true);
        } else {
          habilitarNivel(nivel.id, false);
        }
      });
      cargarGaleria();
      cargarPortada();
    }

    // Guardar progreso en localStorage
    function guardarProgreso() {
      const progreso = {};
      niveles.forEach(nivel => {
        if (nivel.completed) progreso[nivel.id] = true;
      });
      localStorage.setItem("guardianesProgreso", JSON.stringify(progreso));
    }

    // Habilitar o deshabilitar niveles y botones según progreso
    function habilitarNivel(nivelId, completo) {
      niveles.forEach((nivel, index) => {
        const inputFile = document.getElementById(nivel.uploadInput);
        const btn = document.getElementById(nivel.btnCompletar);
        if (nivel.id === nivelId) {
          inputFile.disabled = completo; // Si ya completado no subir más
          btn.disabled = !inputFile.files.length && !completo; // habilita botón si hay archivo o ya completado
        }
        if (nivel.id === nivelId + 1) {
          inputFile.disabled = !completo; // siguiente nivel sólo se habilita si anterior completo
          btn.disabled = true;
        }
      });
    }

    // Mostrar felicitación con familia y planeta feliz
    function mostrarFelicitacion(nivelId) {
      const felicitacion = document.getElementById("felicitacion");
      felicitacion.innerHTML = `
        <div style="font-size:1.4rem; font-weight:bold; color:#2e7d32;">
          ¡Felicitaciones por completar el desafío ${nivelId}!
        </div>
        <img src="https://i.ibb.co/1zYNfZT/familia-planeta-feliz.png" alt="Familia abrazando planeta feliz" style="width:150px; margin-top:15px;" />
      `;
      felicitacion.style.display = "block";
      setTimeout(() => {
        felicitacion.style.display = "none";
      }, 5000);
    }

    // Manejar subida y guardar archivo en localStorage (base64)
    function manejarSubida(nivelId) {
      const nivel = niveles.find(n => n.id === nivelId);
      const input = document.getElementById(nivel.uploadInput);
      const btn = document.getElementById(nivel.btnCompletar);
      if (!input.files.length) {
        btn.disabled = true;
        return;
      }
      btn.disabled = false;
      btn.onclick = () => {
        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
          // Guardar archivo base64 en localStorage con clave por nivel
          let archivos = JSON.parse(localStorage.getItem("guardianesArchivos")) || {};
          archivos[nivelId] = { 
            tipo: nivel.tipo, 
            nombre: file.name, 
            contenido: e.target.result 
          };
          localStorage.setItem("guardianesArchivos", JSON.stringify(archivos));

          nivel.completed = true;
          guardarProgreso();
          habilitarNivel(nivelId, true);
          mostrarFelicitacion(nivelId);
          cargarGaleria();
          input.value = "";
          btn.disabled = true;
        };

        reader.readAsDataURL(file);
      };
    }

    // Cargar galería con todas las imágenes/videos subidos
    function cargarGaleria() {
      const galeria = document.getElementById("galeriaContainer");
      galeria.innerHTML = "";
      const archivos = JSON.parse(localStorage.getItem("guardianesArchivos")) || {};

      Object.keys(archivos).forEach(key => {
        const archivo = archivos[key];
        let elemento;

        if (archivo.tipo === "image") {
          elemento = document.createElement("img");
          elemento.src = archivo.contenido;
          elemento.alt = `Archivo subido: ${archivo.nombre}`;
          elemento.style.maxWidth = "100%";
          elemento.style.borderRadius = "10px";
          elemento.style.marginBottom = "15px";
        } else if (archivo.tipo === "video") {
          elemento = document.createElement("video");
          elemento.src = archivo.contenido;
          elemento.controls = true;
          elemento.style.maxWidth = "100%";
          elemento.style.borderRadius = "10px";
          elemento.style.marginBottom = "15px";
        }
        galeria.appendChild(elemento);
      });
    }

    // Descargar diploma como PNG (simple con canvas)
    function descargarDiploma() {
      const canvas = document.createElement("canvas");
      canvas.width = 800;
      canvas.height = 600;
      const ctx = canvas.getContext("2d");

      // Fondo verde claro
      ctx.fillStyle = "#a5d6a7";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Texto diploma
      ctx.fillStyle = "#1b5e20";
      ctx.font = "bold 36px 'Segoe UI'";
      ctx.textAlign = "center";
      ctx.fillText("Diploma de Pequeño Guardián", canvas.width / 2, 100);

      ctx.font = "24px 'Segoe UI'";
      ctx.fillText("Instituto San Francisco de Asís", canvas.width / 2, 160);

      ctx.font = "20px 'Segoe UI'";
      ctx.fillText("Reconoce a:", canvas.width / 2, 220);

      ctx.font = "italic 28px 'Segoe UI'";
      ctx.fillText("¡Tú!", canvas.width / 2, 270);

      ctx.font = "20px 'Segoe UI'";
      ctx.fillText("Por su compromiso con el cuidado del medio ambiente en familia.", canvas.width / 2, 320);

      // Dibujo simple de planeta feliz (circulo y cara)
      ctx.fillStyle = "#4caf50";
      ctx.beginPath();
      ctx.arc(canvas.width / 2, 450, 70, 0, 2 * Math.PI);
      ctx.fill();

      ctx.fillStyle = "#a5d6a7";
      ctx.beginPath();
      ctx.arc(canvas.width / 2 - 25, 430, 15, 0, 2 * Math.PI);
      ctx.arc(canvas.width / 2 + 25, 430, 15, 0, 2 * Math.PI);
      ctx.fill();

      ctx.fillStyle = "#1b5e20";
      ctx.beginPath();
      ctx.arc(canvas.width / 2 - 25, 430, 7, 0, 2 * Math.PI);
      ctx.arc(canvas.width / 2 + 25, 430, 7, 0, 2 * Math.PI);
      ctx.fill();

      ctx.strokeStyle = "#1b5e20";
      ctx
